<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Calc Pro + eWeLink</title>
    
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" id="manifest-placeholder">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #2c3e50, #4ca1af); min-height: 100vh; padding: 10px; }
        .container { max-width: 850px; margin: 0 auto; background: rgba(255, 255, 255, 0.98); border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        h1 { text-align: center; font-size: 22px; margin-bottom: 15px; color: #2c3e50; }
        .tariff-info { text-align: center; font-size: 11px; color: #666; margin-bottom: 15px; background: #f0f2f5; padding: 8px; border-radius: 8px; }
        .input-section { max-width: 500px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        .toggle-container { display: flex; gap: 5px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: bold; background: #f8f9fa; }
        .toggle-btn.active { background: #3498db; color: white; border-color: #2980b9; }
        .btn-calc { width: 100%; background: #27ae60; color: white; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .actions { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-action { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 11px; font-weight: bold; cursor: pointer; color: white; }
        .btn-ewelink { background: #00a8ff; }
        .btn-export { background: #34495e; }
        #fileInput { display: none; }
        .history-section { margin-top: 30px; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 500px; }
        th { background: #f4f4f4; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .btn-delete { background: #ff7675; color: white; border: none; padding: 5px 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="input-section">
            <h1>‚ö° EV Calc Pro</h1>
            <div class="tariff-info">
                –î–Ω–µ–≤–Ω–∞: 0.293 –ª–≤. | –ù–æ—â–Ω–∞: 0.173 –ª–≤. | 1‚Ç¨ = 1.95583 –ª–≤.
            </div>

            <div class="toggle-container">
                <button id="s_summer" class="toggle-btn active" onclick="setSeason('summer')">–õ—è—Ç–æ (23-07)</button>
                <button id="s_winter" class="toggle-btn" onclick="setSeason('winter')">–ó–∏–º–∞ (22-06)</button>
            </div>

            <div class="toggle-container">
                <button id="m_start" class="toggle-btn active" onclick="setMode('start')">–ù–∞—á. —á–∞—Å</button>
                <button id="m_range" class="toggle-btn" onclick="setMode('range')">–ò–Ω—Ç–µ—Ä–≤–∞–ª</button>
                <button id="m_kwh" class="toggle-btn" onclick="setMode('kwh')">kWh</button>
            </div>

            <div id="batteryFields">
                <div class="grid">
                    <div class="input-group"><label>–¢–µ–∫—É—â %</label><input type="number" id="curPct" value="20"></div>
                    <div class="input-group"><label>–ñ–µ–ª–∞–Ω %</label><input type="number" id="tarPct" value="80"></div>
                </div>
                <div class="grid">
                    <div class="input-group"><label>–ë–∞—Ç–µ—Ä–∏—è (kWh)</label><input type="number" id="cap" value="84"></div>
                    <div class="input-group"><label>–ú–æ—â–Ω–æ—Å—Ç (kW)</label><input type="number" id="pwr" value="2.3"></div>
                </div>
            </div>

            <div id="kwhField" style="display: none;" class="input-group">
                <label>–û–±—â–æ kWh:</label><input type="number" id="manualKwh" placeholder="45.5">
            </div>

            <div class="grid">
                <div class="input-group"><label>–ù–∞—á–∞–ª–æ</label><input type="date" id="d1"><input type="time" id="t1" value="22:00"></div>
                <div id="endGroup" class="input-group" style="display:none;"><label>–ö—Ä–∞–π</label><input type="date" id="d2"><input type="time" id="t2" value="08:00"></div>
            </div>

            <button class="btn-calc" onclick="calculate()">–ò–ó–ß–ò–°–õ–ò –ò –ó–ê–ü–ò–®–ò</button>

            <div class="actions">
                <button class="btn-action btn-ewelink" onclick="document.getElementById('fileInput').click()">üì• –ò–º–ø–æ—Ä—Ç eWeLink</button>
                <button class="btn-action btn-export" onclick="exportToCSV()">‚¨á –ï–∫—Å–ø–æ—Ä—Ç Excel</button>
                <input type="file" id="fileInput" accept=".csv" onchange="importEwelink(this)">
            </div>
        </div>

        <div class="history-section">
            <h3>üìã –î–Ω–µ–≤–Ω–∏–∫</h3>
            <div class="table-wrapper">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>–ü–µ—Ä–∏–æ–¥</th>
                            <th>–û–±—â–æ kWh</th>
                            <th>–î–Ω / –ù–æ—â kWh</th>
                            <th>–°—É–º–∞ (–ª–≤ / ‚Ç¨)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const EUR_RATE = 1.95583;
        let season = 'summer';
        let mode = 'start';

        document.getElementById('d1').valueAsDate = new Date();
        document.getElementById('d2').valueAsDate = new Date();

        function setSeason(s) {
            season = s;
            document.getElementById('s_summer').className = s === 'summer' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('s_winter').className = s === 'winter' ? 'toggle-btn active' : 'toggle-btn';
        }

        function setMode(m) {
            mode = m;
            document.getElementById('m_start').className = m === 'start' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('m_range').className = m === 'range' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('m_kwh').className = m === 'kwh' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('batteryFields').style.display = m === 'kwh' ? 'none' : 'block';
            document.getElementById('kwhField').style.display = m === 'kwh' ? 'block' : 'none';
            document.getElementById('endGroup').style.display = m === 'start' ? 'none' : 'block';
        }

        function calculate() {
            const nightLimit = season === 'summer' ? { s: 23, e: 7 } : { s: 22, e: 6 };
            const start = new Date(document.getElementById('d1').value + ' ' + document.getElementById('t1').value);
            let end, totalKwh;

            if (mode === 'start') {
                const c = parseFloat(document.getElementById('cap').value);
                const p = parseFloat(document.getElementById('pwr').value);
                totalKwh = ((document.getElementById('tarPct').value - document.getElementById('curPct').value) / 100) * c;
                end = new Date(start.getTime() + (totalKwh / p) * 3600000);
            } else {
                end = new Date(document.getElementById('d2').value + ' ' + document.getElementById('t2').value);
                totalKwh = (mode === 'kwh') ? parseFloat(document.getElementById('manualKwh').value) : ((end - start) / 3600000) * parseFloat(document.getElementById('pwr').value);
            }

            processAndSave(start, end, totalKwh);
        }

        function processAndSave(start, end, totalKwh) {
            const nightLimit = season === 'summer' ? { s: 23, e: 7 } : { s: 22, e: 6 };
            let nightKwh = 0, dayKwh = 0;
            const minutes = (end - start) / 60000;
            const kwhPerMin = totalKwh / minutes;
            
            let curr = new Date(start);
            while (curr < end) {
                let h = curr.getHours();
                let isNight = (nightLimit.s > nightLimit.e) ? (h >= nightLimit.s || h < nightLimit.e) : (h >= nightLimit.s && h < nightLimit.e);
                if (isNight) nightKwh += kwhPerMin; else dayKwh += kwhPerMin;
                curr.setMinutes(curr.getMinutes() + 1);
            }

            const pBGN = (nightKwh * 0.173) + (dayKwh * 0.293);
            saveToHistory({
                start: start.toLocaleString('bg-BG', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}),
                end: end.toLocaleString('bg-BG', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}),
                total: totalKwh.toFixed(1),
                dayKwh: dayKwh.toFixed(2),
                nightKwh: nightKwh.toFixed(2),
                bgn: pBGN.toFixed(2),
                eur: (pBGN / EUR_RATE).toFixed(2)
            });
        }

        function importEwelink(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                const dailyData = {};
                const nightLimit = season === 'summer' ? { s: 23, e: 7 } : { s: 22, e: 6 };

                // –ó–∞–ø–æ—á–≤–∞–º–µ –æ—Ç —Ä–µ–¥ 1, –∑–∞—â–æ—Ç–æ —Ä–µ–¥ 0 –µ –∑–∞–≥–ª–∞–≤–Ω–∞—Ç–∞ —á–∞—Å—Ç
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length < 3) continue;

                    const date = cols[0].trim(); // 2026-01-06
                    const timeRange = cols[1].trim(); // 23:00-24:00
                    const kwh = parseFloat(cols[2]);

                    if (isNaN(kwh) || kwh <= 0) continue;

                    if (!dailyData[date]) dailyData[date] = { dayKwh: 0, nightKwh: 0, total: 0 };

                    const startHour = parseInt(timeRange.split(':')[0]);
                    let isNight = (nightLimit.s > nightLimit.e) ? (startHour >= nightLimit.s || startHour < nightLimit.e) : (startHour >= nightLimit.s && startHour < nightLimit.e);
                    
                    if (isNight) dailyData[date].nightKwh += kwh;
                    else dailyData[date].dayKwh += kwh;
                    dailyData[date].total += kwh;
                }

                for (const date in dailyData) {
                    const d = dailyData[date];
                    const pBGN = (d.nightKwh * 0.173) + (d.dayKwh * 0.293);
                    saveToHistory({
                        start: date + " (eWeLink)",
                        end: "–ê–≤—Ç–æ –æ—Ç—á–µ—Ç",
                        total: d.total.toFixed(2),
                        dayKwh: d.dayKwh.toFixed(2),
                        nightKwh: d.nightKwh.toFixed(2),
                        bgn: pBGN.toFixed(2),
                        eur: (pBGN / EUR_RATE).toFixed(2)
                    }, false);
                }
                renderHistory();
                alert("–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–∏ —É—Å–ø–µ—à–Ω–æ!");
            };
            reader.readAsText(file);
        }

        function saveToHistory(item, render = true) {
            let history = JSON.parse(localStorage.getItem('ev_final_v3') || '[]');
            item.id = Date.now() + Math.random();
            history.unshift(item);
            localStorage.setItem('ev_final_v3', JSON.stringify(history.slice(0, 100)));
            if (render) renderHistory();
        }

        function renderHistory() {
            let history = JSON.parse(localStorage.getItem('ev_final_v3') || '[]');
            document.getElementById('historyBody').innerHTML = history.map(i => `
                <tr>
                    <td>${i.start}<br><small>${i.end}</small></td>
                    <td><b>${i.total}</b> kWh</td>
                    <td>–î: ${i.dayKwh}<br>–ù: ${i.nightKwh}</td>
                    <td><b>${i.bgn} –ª–≤</b><br><small>${i.eur} ‚Ç¨</small></td>
                    <td><button class="btn-delete" onclick="deleteEntry(${i.id})">‚úï</button></td>
                </tr>
            `).join('');
        }

        function deleteEntry(id) {
            let history = JSON.parse(localStorage.getItem('ev_final_v3') || '[]');
            localStorage.setItem('ev_final_v3', JSON.stringify(history.filter(i => i.id !== id)));
            renderHistory();
        }

        function exportToCSV() {
            let history = JSON.parse(localStorage.getItem('ev_final_v3') || '[]');
            let csv = "\uFEFF–ù–∞—á–∞–ª–æ,–ö—Ä–∞–π,–û–±—â–æ kWh,–î–Ω–µ–≤–Ω–∞ kWh,–ù–æ—â–Ω–∞ kWh,–¶–µ–Ω–∞ –ª–≤,–¶–µ–Ω–∞ EUR\n";
            history.forEach(i => csv += `${i.start},${i.end},${i.total},${i.dayKwh},${i.nightKwh},${i.bgn},${i.eur}\n`);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `EV_Report.csv`;
            link.click();
        }

        renderHistory();
    </script>
</body>
</html>
