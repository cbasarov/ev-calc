<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Calc Pro + Export</title>
    
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" id="manifest-placeholder">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 850px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .input-section { max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; font-size: 22px; margin-bottom: 5px; color: #2c3e50; }
        
        .tariff-info {
            text-align: center; font-size: 11px; color: #666;
            margin-bottom: 15px; background: #f0f2f5; padding: 5px; border-radius: 5px;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #444; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        
        .toggle-container { display: flex; gap: 5px; margin-bottom: 15px; }
        .toggle-btn { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: bold; background: #f8f9fa; }
        .toggle-btn.active { background: #3498db; color: white; border-color: #2980b9; }

        .btn-calc { width: 100%; background: #27ae60; color: white; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        .result { margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 10px; text-align: center; display: none; }
        .price-bgn { color: #2e7d32; font-size: 1.5em; font-weight: bold; display: block; }
        
        .history-section { margin-top: 30px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        h3 { font-size: 16px; color: #2c3e50; }
        
        .btn-export { background: #34495e; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; font-weight: bold; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 500px; }
        th { background: #f4f4f4; padding: 10px; text-align: left; color: #555; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .btn-delete { background: #ff7675; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; }
        
        .badge { background: #eee; padding: 2px 5px; border-radius: 4px; font-size: 10px; display: inline-block; margin-top: 2px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="input-section">
            <h1>‚ö° EV Calc Pro</h1>
            <div class="tariff-info">
                –î–Ω–µ–≤–Ω–∞: 0.293 –ª–≤. | –ù–æ—â–Ω–∞: 0.173 –ª–≤. | 1‚Ç¨ = 1.95583 –ª–≤.
            </div>

            <div class="toggle-container">
                <button id="s_summer" class="toggle-btn active" onclick="setSeason('summer')">–õ—è—Ç–æ (23-07)</button>
                <button id="s_winter" class="toggle-btn" onclick="setSeason('winter')">–ó–∏–º–∞ (22-06)</button>
            </div>

            <div class="toggle-container">
                <button id="m_start" class="toggle-btn active" onclick="setMode('start')">–ù–∞—á. —á–∞—Å</button>
                <button id="m_range" class="toggle-btn" onclick="setMode('range')">–ò–Ω—Ç–µ—Ä–≤–∞–ª</button>
                <button id="m_kwh" class="toggle-btn" onclick="setMode('kwh')">kWh</button>
            </div>

            <div id="batteryFields">
                <div class="grid">
                    <div class="input-group"><label>–¢–µ–∫—É—â %</label><input type="number" id="curPct" value="20"></div>
                    <div class="input-group"><label>–ñ–µ–ª–∞–Ω %</label><input type="number" id="tarPct" value="80"></div>
                </div>
                <div class="grid">
                    <div class="input-group"><label>–ë–∞—Ç–µ—Ä–∏—è (kWh)</label><input type="number" id="cap" value="84"></div>
                    <div class="input-group"><label>–ú–æ—â–Ω–æ—Å—Ç (kW)</label><input type="number" id="pwr" value="2.3"></div>
                </div>
            </div>

            <div id="kwhField" style="display: none;" class="input-group">
                <label>–û–±—â–æ –∑–∞—Ä–µ–¥–µ–Ω–∏ kWh:</label>
                <input type="number" id="manualKwh" placeholder="45.5">
            </div>

            <div class="grid">
                <div class="input-group"><label>–ù–∞—á–∞–ª–æ</label><input type="date" id="d1"><input type="time" id="t1" value="22:00"></div>
                <div id="endGroup" class="input-group" style="display:none;"><label>–ö—Ä–∞–π</label><input type="date" id="d2"><input type="time" id="t2" value="08:00"></div>
            </div>

            <button class="btn-calc" onclick="calculate()">–ò–ó–ß–ò–°–õ–ò –ò –ó–ê–ü–ò–®–ò</button>

            <div id="resultArea" class="result">
                <span class="price-bgn" id="outPriceBGN"></span>
                <span style="color:#666; font-size: 0.9em;" id="outPriceEUR"></span>
            </div>
        </div>

        <div class="history-section">
            <div class="history-header">
                <h3>üìã –î–Ω–µ–≤–Ω–∏–∫</h3>
                <button class="btn-export" onclick="exportToCSV()">‚¨á –ï–∫—Å–ø–æ—Ä—Ç Excel (CSV)</button>
            </div>
            <div class="table-wrapper">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>–ü–µ—Ä–∏–æ–¥ (–ù–∞—á–∞–ª–æ - –ö—Ä–∞–π)</th>
                            <th>–û–±—â–æ kWh</th>
                            <th>–î–Ω–µ–≤–Ω–∞ / –ù–æ—â–Ω–∞</th>
                            <th>–°—É–º–∞ (–ª–≤ / ‚Ç¨)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        /* PWA Manifest */
        const manifest = { "name": "EV Calc Pro", "short_name": "EV Calc", "start_url": ".", "display": "standalone", "background_color": "#2c3e50", "theme_color": "#2c3e50", "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/3104/3104859.png", "sizes": "512x512", "type": "image/png"}] };
        document.querySelector('#manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})));
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`self.addEventListener('fetch', function(event) {});`)); }

        /* LOGIC */
        const EUR_RATE = 1.95583;
        let season = 'summer';
        let mode = 'start';

        document.getElementById('d1').valueAsDate = new Date();
        document.getElementById('d2').valueAsDate = new Date();

        function setSeason(s) {
            season = s;
            document.getElementById('s_summer').className = s === 'summer' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('s_winter').className = s === 'winter' ? 'toggle-btn active' : 'toggle-btn';
        }

        function setMode(m) {
            mode = m;
            document.getElementById('m_start').className = m === 'start' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('m_range').className = m === 'range' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('m_kwh').className = m === 'kwh' ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('batteryFields').style.display = m === 'kwh' ? 'none' : 'block';
            document.getElementById('kwhField').style.display = m === 'kwh' ? 'block' : 'none';
            document.getElementById('endGroup').style.display = m === 'start' ? 'none' : 'block';
        }

        function calculate() {
            const nightLimit = season === 'summer' ? { s: 23, e: 7 } : { s: 22, e: 6 };
            const start = new Date(document.getElementById('d1').value + ' ' + document.getElementById('t1').value);
            let end, totalKwh;

            if (mode === 'start') {
                const c = parseFloat(document.getElementById('cap').value);
                const p = parseFloat(document.getElementById('pwr').value);
                totalKwh = ((document.getElementById('tarPct').value - document.getElementById('curPct').value) / 100) * c;
                end = new Date(start.getTime() + (totalKwh / p) * 3600000);
            } else {
                end = new Date(document.getElementById('d2').value + ' ' + document.getElementById('t2').value);
                totalKwh = (mode === 'kwh') ? parseFloat(document.getElementById('manualKwh').value) : ((end - start) / 3600000) * parseFloat(document.getElementById('pwr').value);
            }

            if (end <= start || isNaN(totalKwh)) { alert("–ì—Ä–µ—à–∫–∞ –≤ –¥–∞–Ω–Ω–∏—Ç–µ!"); return; }

            let nightKwh = 0, dayKwh = 0;
            const kwhPerMin = totalKwh / ((end - start) / 60000);
            let current = new Date(start);
            while (current < end) {
                let h = current.getHours();
                let isNight = (nightLimit.s > nightLimit.e) ? (h >= nightLimit.s || h < nightLimit.e) : (h >= nightLimit.s && h < nightLimit.e);
                if (isNight) nightKwh += kwhPerMin; else dayKwh += kwhPerMin;
                current.setMinutes(current.getMinutes() + 1);
            }

            const pBGN = (nightKwh * 0.173) + (dayKwh * 0.293);
            const pEUR = pBGN / EUR_RATE;

            document.getElementById('outPriceBGN').textContent = pBGN.toFixed(2) + " –ª–≤.";
            document.getElementById('outPriceEUR').textContent = "‚âà " + pEUR.toFixed(2) + " ‚Ç¨";
            document.getElementById('resultArea').style.display = 'block';

            saveToHistory({ 
                start: start.toLocaleString('bg-BG', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}),
                end: end.toLocaleString('bg-BG', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}),
                total: totalKwh.toFixed(1),
                dayKwh: dayKwh.toFixed(2),
                nightKwh: nightKwh.toFixed(2),
                bgn: pBGN.toFixed(2),
                eur: pEUR.toFixed(2)
            });
        }

        function saveToHistory(item) {
            let history = JSON.parse(localStorage.getItem('ev_final_v2') || '[]');
            item.id = Date.now();
            history.unshift(item);
            localStorage.setItem('ev_final_v2', JSON.stringify(history.slice(0, 50)));
            renderHistory();
        }

        function renderHistory() {
            let history = JSON.parse(localStorage.getItem('ev_final_v2') || '[]');
            document.getElementById('historyBody').innerHTML = history.map(i => `
                <tr>
                    <td>–û—Ç: ${i.start}<br>–î–æ: ${i.end}</td>
                    <td><b>${i.total}</b> kWh</td>
                    <td>–î–Ω: ${i.dayKwh}<br>–ù–æ—â: ${i.nightKwh}</td>
                    <td><b>${i.bgn} –ª–≤</b><br><small>${i.eur} ‚Ç¨</small></td>
                    <td><button class="btn-delete" onclick="deleteEntry(${i.id})">‚úï</button></td>
                </tr>
            `).join('');
        }

        function deleteEntry(id) {
            let history = JSON.parse(localStorage.getItem('ev_final_v2') || '[]');
            localStorage.setItem('ev_final_v2', JSON.stringify(history.filter(i => i.id !== id)));
            renderHistory();
        }

        function exportToCSV() {
            let history = JSON.parse(localStorage.getItem('ev_final_v2') || '[]');
            if (history.length === 0) { alert("–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –µ–∫—Å–ø–æ—Ä—Ç!"); return; }
            
            let csvContent = "\uFEFF"; // BOM –∑–∞ –ø—Ä–∞–≤–∏–ª–Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü–∞ –≤ Excel
            csvContent += "–ù–∞—á–∞–ª–æ,–ö—Ä–∞–π,–û–±—â–æ kWh,–î–Ω–µ–≤–Ω–∞ kWh,–ù–æ—â–Ω–∞ kWh,–¶–µ–Ω–∞ –ª–≤,–¶–µ–Ω–∞ EUR\n";
            
            history.forEach(i => {
                csvContent += `${i.start},${i.end},${i.total},${i.dayKwh},${i.nightKwh},${i.bgn},${i.eur}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `EV_Charging_Report_${new Date().toLocaleDateString()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        renderHistory();
    </script>
</body>
</html>
