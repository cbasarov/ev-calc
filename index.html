<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Calc Pro - Euro Edition</title>
    
    <meta name="theme-color" content="#2c3e50">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #2c3e50, #4ca1af); min-height: 100vh; padding: 10px; }
        .container { max-width: 900px; margin: 0 auto; background: rgba(255, 255, 255, 0.98); border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); }
        
        .lang-switch { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .lang-btn { background: #eee; border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; border-radius: 5px; font-size: 12px; margin-left: 5px; }
        .lang-btn.active { background: #34495e; color: white; }

        h1 { text-align: center; font-size: 22px; margin-bottom: 15px; color: #2c3e50; }
        .tariff-info { text-align: center; font-size: 11px; color: #666; margin-bottom: 15px; background: #f0f2f5; padding: 8px; border-radius: 8px; }
        .input-section { max-width: 600px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        
        .check-wrap { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 11px; font-weight: bold; color: #2c3e50; }
        .check-wrap input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        .disabled-field { opacity: 0.3; pointer-events: none; }

        .toggle-container { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .toggle-btn { flex: 1; min-width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: bold; background: #f8f9fa; }
        .toggle-btn.active { background: #3498db; color: white; border-color: #2980b9; }
        
        .calc-actions { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; margin-top: 10px; }
        .btn-calc { padding: 15px; border: none; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .btn-only-calc { background: #95a5a6; color: white; }
        .btn-save-calc { background: #27ae60; color: white; }

        .actions { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-action { flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 11px; font-weight: bold; cursor: pointer; color: white; }
        .btn-ewelink { background: #00a8ff; }
        .btn-export { background: #34495e; }
        #fileInput { display: none; }
        .history-section { margin-top: 30px; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 600px; }
        th { background: #f4f4f4; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        .btn-delete { background: #ff7675; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; }
        .calc-result-hint { background: #e8f4fd; border-left: 4px solid #3498db; padding: 15px; margin-top: 15px; font-size: 13px; display: none; border-radius: 4px; line-height: 1.5; }
        .badge-save { background: #2ecc71; color: white; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <div class="lang-switch">
            <button class="lang-btn" id="btn-bg" onclick="setLanguage('bg')">BG</button>
            <button class="lang-btn" id="btn-en" onclick="setLanguage('en')">EN</button>
        </div>

        <div class="input-section">
            <h1 id="txt-title">‚ö° EV Calc Pro (‚Ç¨)</h1>
            <div class="tariff-info" id="txt-tariff">
                Day: 0.150 ‚Ç¨ | Night: 0.088 ‚Ç¨ | Fuel: 1.33 ‚Ç¨/L
            </div>

            <div class="toggle-container">
                <button id="s_summer" class="toggle-btn active" onclick="setSeason('summer')">–õ—è—Ç–æ (23-07)</button>
                <button id="s_winter" class="toggle-btn" onclick="setSeason('winter')">–ó–∏–º–∞ (22-06)</button>
            </div>

            <div class="toggle-container">
                <button id="m_start" class="toggle-btn active" onclick="setMode('start')">–ù–∞—á. —á–∞—Å</button>
                <button id="m_target" class="toggle-btn" onclick="setMode('target')">–ì–æ—Ç–æ–≤–∞ –≤</button>
                <button id="m_range" class="toggle-btn" onclick="setMode('range')">–ò–Ω—Ç–µ—Ä–≤–∞–ª</button>
                <button id="m_kwh" class="toggle-btn" onclick="setMode('kwh')">kWh</button>
            </div>

            <div id="batteryFields">
                <div class="grid">
                    <div class="input-group"><label id="txt-curPct">–¢–µ–∫—É—â %</label><input type="number" id="curPct" value="20"></div>
                    <div class="input-group"><label id="txt-tarPct">–ñ–µ–ª–∞–Ω %</label><input type="number" id="tarPct" value="80"></div>
                </div>
                
                <div class="grid-3">
                    <div class="input-group"><label id="txt-cap">–ë–∞—Ç–µ—Ä–∏—è (kWh)</label><input type="number" id="cap" value="84"></div>
                    <div class="input-group"><label id="txt-pwr">–ú–æ—â–Ω–æ—Å—Ç (kW)</label><input type="number" id="pwr" value="2.3"></div>
                    <div class="input-group" id="consGroup">
                        <div class="check-wrap" style="margin-bottom:0">
                            <input type="checkbox" id="useCons" checked onclick="updateToggles()">
                            <label id="txt-cons" style="margin:0">–†–∞–∑—Ö–æ–¥ (kWh/100)</label>
                        </div>
                        <input type="number" id="cons" value="18">
                    </div>
                </div>
                
                <div class="check-wrap">
                    <input type="checkbox" id="useFuel" checked onclick="updateToggles()">
                    <span id="txt-use-fuel">–ò–∑—á–∏—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≥–æ—Ä–∏–≤–æ</span>
                </div>

                <div class="grid" id="fuelInputs">
                   <div class="input-group"><label id="txt-fuel-cons">–†–∞–∑—Ö–æ–¥ –ì–æ—Ä–∏–≤–æ (L/100km)</label><input type="number" id="fuelCons" value="7"></div>
                   <div class="input-group"><label id="txt-fuel-price">–¶–µ–Ω–∞ –ì–æ—Ä–∏–≤–æ (‚Ç¨/L)</label><input type="number" id="fuelPrice" value="1.33"></div>
                </div>
            </div>

            <div id="kwhField" style="display: none;" class="input-group">
                <label id="txt-manualKwh">–û–±—â–æ kWh:</label><input type="number" id="manualKwh" placeholder="45.5">
            </div>

            <div class="grid">
                <div class="input-group"><label id="txt-date1">–ù–∞—á–∞–ª–æ</label><input type="date" id="d1"><input type="time" id="t1" value="22:00"></div>
                <div id="endGroup" class="input-group" style="display:none;"><label id="txt-date2">–ö—Ä–∞–π</label><input type="date" id="d2"><input type="time" id="t2" value="08:00"></div>
            </div>

            <div id="calc-hint" class="calc-result-hint"></div>

            <div class="calc-actions">
                <button class="btn-calc btn-only-calc" id="txt-calcOnly" onclick="calculate(false)">–°–ê–ú–û –ò–ó–ß–ò–°–õ–ò</button>
                <button class="btn-calc btn-save-calc" id="txt-calcBtn" onclick="calculate(true)">–ò–ó–ß–ò–°–õ–ò –ò –ó–ê–ü–ò–®–ò</button>
            </div>

            <div class="actions">
                <button class="btn-action btn-ewelink" id="txt-import" onclick="document.getElementById('fileInput').click()">üì• eWeLink</button>
                <button class="btn-action btn-export" id="txt-export" onclick="exportToCSV()">‚¨á Excel</button>
                <input type="file" id="fileInput" accept=".csv" onchange="importEwelink(this)">
            </div>
        </div>

        <div class="history-section">
            <h3 id="txt-history-title">üìã –î–Ω–µ–≤–Ω–∏–∫</h3>
            <div class="table-wrapper">
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th id="th-period">–ü–µ—Ä–∏–æ–¥</th>
                            <th id="th-total">kWh</th>
                            <th id="th-added">–ü—Ä–æ–±–µ–≥</th>
                            <th id="th-cost">–¶–µ–Ω–∞ (‚Ç¨)</th>
                            <th id="th-saved">–°–ø–µ—Å—Ç–µ–Ω–æ (‚Ç¨)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let season = 'summer';
        let mode = 'start';
        let lang = localStorage.getItem('ev_lang') || 'bg';

        const i18n = {
            bg: {
                title: "‚ö° EV Calc Pro (‚Ç¨)",
                tariff: "–î–Ω–µ–≤–Ω–∞: 0.150 ‚Ç¨ | –ù–æ—â–Ω–∞: 0.088 ‚Ç¨ | –ì–æ—Ä–∏–≤–æ: 1.33 ‚Ç¨/–ª",
                summer: "–õ—è—Ç–æ (23-07)", winter: "–ó–∏–º–∞ (22-06)", mStart: "–ù–∞—á. —á–∞—Å", mTarget: "–ì–æ—Ç–æ–≤–∞ –≤", mRange: "–ò–Ω—Ç–µ—Ä–≤–∞–ª",
                curPct: "–¢–µ–∫—É—â %", tarPct: "–ñ–µ–ª–∞–Ω %", cap: "–ë–∞—Ç–µ—Ä–∏—è (kWh)", pwr: "–ú–æ—â–Ω–æ—Å—Ç (kW)", cons: "–†–∞–∑—Ö–æ–¥ (kWh/100)",
                fuelCons: "–†–∞–∑—Ö–æ–¥ –ì–æ—Ä–∏–≤–æ (–ª/100)", fuelPrice: "–¶–µ–Ω–∞ –ì–æ—Ä–∏–≤–æ (‚Ç¨/–ª)", manKwh: "–û–±—â–æ kWh:", dateStart: "–ù–∞—á–∞–ª–æ", dateEnd: "–ö—Ä–∞–π / –ì–æ—Ç–æ–≤–∞ –≤",
                calc: "–ò–ó–ß–ò–°–õ–ò –ò –ó–ê–ü–ò–®–ò", calcOnly: "–°–ê–ú–û –ò–ó–ß–ò–°–õ–ò", import: "üì• eWeLink", export: "‚¨á Excel", history: "üìã –î–Ω–µ–≤–Ω–∏–∫",
                thPeriod: "–ü–µ—Ä–∏–æ–¥", thTotal: "kWh", thAdded: "–ü—Ä–æ–±–µ–≥", thCost: "–¶–µ–Ω–∞ (‚Ç¨)", thSaved: "–°–ø–µ—Å—Ç–µ–Ω–æ (‚Ç¨)",
                useFuel: "–ò–∑—á–∏—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≥–æ—Ä–∏–≤–æ", hintRes: "–†–µ–∑—É–ª—Ç–∞—Ç: "
            },
            en: {
                title: "‚ö° EV Calc Pro (‚Ç¨)",
                tariff: "Day: 0.150 ‚Ç¨ | Night: 0.088 ‚Ç¨ | Fuel: 1.33 ‚Ç¨/L",
                summer: "Summer (23-07)", winter: "Winter (22-06)", mStart: "Start At", mTarget: "Ready At", mRange: "Range",
                curPct: "Current %", tarPct: "Target %", cap: "Battery (kWh)", pwr: "Power (kW)", cons: "Cons. (kWh/100)",
                fuelCons: "Fuel Cons. (l/100)", fuelPrice: "Fuel Price (‚Ç¨/L)", manKwh: "Total kWh:", dateStart: "Start", dateEnd: "End / Ready At",
                calc: "CALCULATE & SAVE", calcOnly: "CALC ONLY", import: "üì• eWeLink", export: "‚¨á Excel", history: "üìã History",
                thPeriod: "Period", thTotal: "kWh", thAdded: "Range", thCost: "Cost (‚Ç¨)", thSaved: "Saved (‚Ç¨)",
                useFuel: "Calculate fuel comparison", hintRes: "Result: "
            }
        };

        function setLanguage(l) { lang = l; localStorage.setItem('ev_lang', l); updateUI(); }

        function updateToggles() {
            const fuelCheck = document.getElementById('useFuel').checked;
            const consCheck = document.getElementById('useCons').checked;
            
            document.getElementById('fuelInputs').classList.toggle('disabled-field', !fuelCheck);
            document.getElementById('cons').classList.toggle('disabled-field', !consCheck);
            
            // –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ
            localStorage.setItem('ev_opt_fuel', fuelCheck);
            localStorage.setItem('ev_opt_cons', consCheck);
        }

        function loadToggles() {
            const fuelSaved = localStorage.getItem('ev_opt_fuel');
            const consSaved = localStorage.getItem('ev_opt_cons');
            
            if (fuelSaved !== null) document.getElementById('useFuel').checked = (fuelSaved === 'true');
            if (consSaved !== null) document.getElementById('useCons').checked = (consSaved === 'true');
            updateToggles();
        }

        function updateUI() {
            const t = i18n[lang];
            document.getElementById('txt-title').innerText = t.title;
            document.getElementById('txt-tariff').innerText = t.tariff;
            document.getElementById('s_summer').innerText = t.summer;
            document.getElementById('s_winter').innerText = t.winter;
            document.getElementById('m_start').innerText = t.mStart;
            document.getElementById('m_target').innerText = t.mTarget;
            document.getElementById('m_range').innerText = t.mRange;
            document.getElementById('txt-curPct').innerText = t.curPct;
            document.getElementById('txt-tarPct').innerText = t.tarPct;
            document.getElementById('txt-cap').innerText = t.cap;
            document.getElementById('txt-pwr').innerText = t.pwr;
            document.getElementById('txt-cons').innerText = t.cons;
            document.getElementById('txt-fuel-cons').innerText = t.fuelCons;
            document.getElementById('txt-fuel-price').innerText = t.fuelPrice;
            document.getElementById('txt-manualKwh').innerText = t.manKwh;
            document.getElementById('txt-use-fuel').innerText = t.useFuel;
            document.getElementById('txt-date1').innerText = (mode === 'target') ? t.dateEnd : t.dateStart;
            document.getElementById('txt-date2').innerText = t.dateEnd;
            document.getElementById('txt-calcBtn').innerText = t.calc;
            document.getElementById('txt-calcOnly').innerText = t.calcOnly;
            document.getElementById('txt-import').innerText = t.import;
            document.getElementById('txt-export').innerText = t.export;
            document.getElementById('txt-history-title').innerText = t.history;
            document.getElementById('th-period').innerText = t.thPeriod;
            document.getElementById('th-total').innerText = t.thTotal;
            document.getElementById('th-added').innerText = t.thAdded;
            document.getElementById('th-cost').innerText = t.thCost;
            document.getElementById('th-saved').innerText = t.thSaved;
            renderHistory();
        }

        document.getElementById('d1').valueAsDate = new Date();
        document.getElementById('d2').valueAsDate = new Date();

        function setSeason(s) {
            season = s;
            document.getElementById('s_summer').classList.toggle('active', s === 'summer');
            document.getElementById('s_winter').classList.toggle('active', s === 'winter');
        }

        function setMode(m) {
            mode = m;
            document.getElementById('m_start').classList.toggle('active', m === 'start');
            document.getElementById('m_target').classList.toggle('active', m === 'target');
            document.getElementById('m_range').classList.toggle('active', m === 'range');
            document.getElementById('m_kwh').classList.toggle('active', m === 'kwh');
            document.getElementById('batteryFields').style.display = m === 'kwh' ? 'none' : 'block';
            document.getElementById('kwhField').style.display = m === 'kwh' ? 'block' : 'none';
            document.getElementById('endGroup').style.display = (m === 'range' || m === 'kwh') ? 'block' : 'none';
            updateUI();
        }

        function calculate(shouldSave = true) {
            const startOrTarget = new Date(document.getElementById('d1').value + ' ' + document.getElementById('t1').value);
            let start, end, totalKwh;
            const c = parseFloat(document.getElementById('cap').value);
            const p = parseFloat(document.getElementById('pwr').value);

            if (mode === 'start') {
                totalKwh = ((document.getElementById('tarPct').value - document.getElementById('curPct').value) / 100) * c;
                start = startOrTarget;
                end = new Date(start.getTime() + (totalKwh / p) * 3600000);
            } else if (mode === 'target') {
                totalKwh = ((document.getElementById('tarPct').value - document.getElementById('curPct').value) / 100) * c;
                end = startOrTarget;
                start = new Date(end.getTime() - (totalKwh / p) * 3600000);
            } else {
                start = startOrTarget;
                end = new Date(document.getElementById('d2').value + ' ' + document.getElementById('t2').value);
                totalKwh = (mode === 'kwh') ? parseFloat(document.getElementById('manualKwh').value) : ((end - start) / 3600000) * p;
            }
            
            processCalculation(start, end, totalKwh, shouldSave);
        }

        function processCalculation(start, end, totalKwh, shouldSave) {
            const nightLimit = season === 'summer' ? { s: 23, e: 7 } : { s: 22, e: 6 };
            let nightKwh = 0, dayKwh = 0;
            const minutes = Math.max(1, Math.abs(end - start) / 60000);
            const kwhPerMin = totalKwh / minutes;
            let curr = new Date(Math.min(start, end));
            const finish = new Date(Math.max(start, end));

            while (curr < finish) {
                let h = curr.getHours();
                let isNight = (nightLimit.s > nightLimit.e) ? (h >= nightLimit.s || h < nightLimit.e) : (h >= nightLimit.s && h < nightLimit.e);
                if (isNight) nightKwh += kwhPerMin; else dayKwh += kwhPerMin;
                curr.setMinutes(curr.getMinutes() + 1);
            }

            const costEV = (nightKwh * 0.088) + (dayKwh * 0.150);
            
            // –õ–æ–≥–∏–∫–∞ –∑–∞ –ø—Ä–æ–±–µ–≥
            let addedRange = 0;
            const useCons = document.getElementById('useCons').checked;
            if (useCons) {
                const evCons = parseFloat(document.getElementById('cons').value);
                addedRange = (totalKwh / evCons) * 100;
            }
            
            // –õ–æ–≥–∏–∫–∞ –∑–∞ –≥–æ—Ä–∏–≤–æ
            let saved = 0;
            const useFuel = document.getElementById('useFuel').checked;
            if (useFuel && useCons) {
                const fCons = parseFloat(document.getElementById('fuelCons').value);
                const fPrice = parseFloat(document.getElementById('fuelPrice').value);
                const costFuel = (addedRange / 100) * fCons * fPrice;
                saved = costFuel - costEV;
            }

            const resultObj = {
                start: start.toLocaleString(lang==='bg'?'bg-BG':'en-GB', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false}),
                end: end.toLocaleString(lang==='bg'?'bg-BG':'en-GB', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false}),
                total: totalKwh.toFixed(1),
                range: addedRange.toFixed(0),
                cost: costEV.toFixed(2),
                saved: saved.toFixed(2)
            };

            const hBox = document.getElementById('calc-hint');
            hBox.style.display = 'block';
            hBox.innerHTML = `
                <strong>${i18n[lang].hintRes}</strong><br>
                ${i18n[lang].thPeriod}: ${resultObj.start} - ${resultObj.end}<br>
                ${i18n[lang].thTotal}: ${resultObj.total} kWh ${useCons ? `(+${resultObj.range} km)` : ''}<br>
                ${i18n[lang].thCost}: ‚Ç¨ ${resultObj.cost} ${useFuel ? `| ${i18n[lang].thSaved}: ‚Ç¨ ${resultObj.saved}` : ''}
            `;

            if (shouldSave) saveToHistory(resultObj);
        }

        function saveToHistory(item) {
            let history = JSON.parse(localStorage.getItem('ev_euro_v1') || '[]');
            item.id = Date.now() + Math.random();
            history.unshift(item);
            localStorage.setItem('ev_euro_v1', JSON.stringify(history.slice(0, 100)));
            renderHistory();
        }

        function renderHistory() {
            let history = JSON.parse(localStorage.getItem('ev_euro_v1') || '[]');
            document.getElementById('historyBody').innerHTML = history.map(i => `
                <tr>
                    <td>${i.start}<br><small>${i.end}</small></td>
                    <td><b>${i.total}</b></td>
                    <td>+${i.range} km</td>
                    <td>‚Ç¨ ${i.cost}</td>
                    <td><span class="badge-save">‚Ç¨ ${i.saved}</span></td>
                    <td><button class="btn-delete" onclick="deleteEntry(${i.id})">‚úï</button></td>
                </tr>
            `).join('');
        }

        function deleteEntry(id) {
            if(confirm(lang === 'bg' ? '–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∑–∞–ø–∏—Å–∞?' : 'Delete this entry?')) {
                let history = JSON.parse(localStorage.getItem('ev_euro_v1') || '[]');
                localStorage.setItem('ev_euro_v1', JSON.stringify(history.filter(i => i.id !== id)));
                renderHistory();
            }
        }

        function exportToCSV() {
            let history = JSON.parse(localStorage.getItem('ev_euro_v1') || '[]');
            let csv = "\uFEFFStart,End,kWh,Range,Cost_EUR,Saved_EUR\n";
            history.forEach(i => csv += `"${i.start}","${i.end}",${i.total},${i.range},${i.cost},${i.saved}\n`);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `EV_Economy_Report_EUR.csv`;
            link.click();
        }

        loadToggles();
        updateUI();
    </script>
</body>
</html>
